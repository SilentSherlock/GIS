<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!--bootstrap针对移动设备优化，设置页面宽度和初始缩放-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Map</title>
    <!--引入字体css-->
    <link rel="stylesheet" href="../static/extlib/font-awesome-4.7.0/css/font-awesome.min.css"
    th:href="@{/extlib/font-awesome-4.7.0/css/font-awesome.min.css}">
    <!--引入bootstrap文件-->
    <link rel="stylesheet" href="../static/extlib/bootstrap-3.3.7/css/bootstrap.css"
    th:href="@{/extlib/bootstrap-3.3.7/css/bootstrap.css}">
    <link rel="stylesheet" href="../static/extlib/bootstrap-3.3.7/css/bootstrap-theme.css"
    th:href="@{/extlib/bootstrap-3.3.7/css/bootstrap-theme.css}">
    <!--js插件引用-->
    <script type="text/javascript" src="../static/extlib/jquery-3.4.1/jquery-3.4.1.min.js"
    th:src="@{/extlib/jquery-3.4.1/jquery-3.4.1.min.js}"></script>
    <script type="text/javascript" src="../static/extlib/bootstrap-3.3.7/js/bootstrap.js"
    th:src="@{/extlib/bootstrap-3.3.7/js/bootstrap.js}"></script>

    <!--leaflet--CDN引用-->
    <!--<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>-->
    <!--本地引用-->
    <link rel="stylesheet" href="../static/extlib/leaflet/leaflet.css"
    th:href="@{/extlib/leaflet/leaflet.css}">
    <script type="text/javascript" src="../static/extlib/leaflet/leaflet-src.js"
    th:src="@{/extlib/leaflet/leaflet-src.js}"></script>
    <!--leaflet插件-->

    <script type="text/javascript" src="../static/extlib/leaflet/leaflet.ChineseTmsProviders.js"
    th:src="@{/extlib/leaflet/leaflet.ChineseTmsProviders.js}"></script>
    <link rel="stylesheet" href="../static/extlib/leaflet/leaflet-geoman.css"
          th:href="@{/extlib/leaflet/leaflet-geoman.css}">
    <script type="text/javascript" src="../static/extlib/leaflet/leaflet-geoman.min.js"
            th:src="@{/extlib/leaflet/leaflet-geoman.min.js}"></script>
    <script type="text/javascript" src="../static/extlib/leaflet/semiCircle.js"
            th:src="@{/extlib/leaflet/semiCircle.js}"></script>
    <link rel="stylesheet" href="../static/extlib/leaflet/leaflet-measure/leaflet-measure.css"
            th:href="@{/extlib/leaflet/leaflet-measure/leaflet-measure.css}">
    <script type="text/javascript" src="../static/extlib/leaflet/leaflet-measure/leaflet-measure.js"
            th:src="@{/extlib/leaflet/leaflet-measure/leaflet-measure.js}"></script>
    <link rel="stylesheet" href="../static/extlib/leaflet/leaflet-beautify-marker-icon.css"
            th:href="@{/extlib/leaflet/leaflet-beautify-marker-icon.css}">
    <script type="text/javascript" src="../static/extlib/leaflet/leaflet_beautify_marker_icon.js"
            th:src="@{/extlib/leaflet/leaflet_beautify_marker_icon.js}"></script>
    <!--echart-->
    <script type="text/javascript" src="../static/extlib/echarts/echarts.js"
            th:src="@{/extlib/echarts/echarts.js}"></script>
    <script type="text/javascript" src="../static/extlib/echarts/theme/purple.js"
            th:src="@{/extlib/echarts/theme/purple.js}"></script>
    <style rel="stylesheet">
        /*  样式中使用颜色
        背景色: #1b1b2d
        侧边栏色: #389466
        文字色: #cccccc
        高亮色: #ffffff
        选项色: #e14eca
        分块内容背景色: #27293d
        */
        /*其他页面可复用样式*/
        html, body{
            height: 100%;
        }
        body {
            padding-top: 50px;
            background: #1b1b2d;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            color: #cccccc;
            margin: 0;
        }
        ::-webkit-scrollbar {
            background-color: #1c1e1f;
            color: #c5c1b9;
        }
        ::-webkit-scrollbar-corner {
            background-color: #181a1b;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #2a2c2e;
        }
        .nav li a {
            color: #cccccc;
        }
        .nav li a:hover, .nav li a:focus {
            background: none;
            color: #ffffff;
            border: none;
        }
        /*顶端导航栏样式*/
        ._topbar {
            background: #1b1b2d;
            border-bottom-color: #389466;
        }
        ._topbar .navbar-nav > li > a {
            color: #cccccc;
        }
        ._topbar .navbar-nav > li > a:hover , ._topbar .navbar-nav > li > a:focus{
            background: none;
            color: #ffffff;
        }
        ._topbar .navbar-brand {
            color: #389466;
        }
        ._topbar .navbar-brand:hover, :focus{
            color: #389466;
        }
        ._topbar .navbar-nav .open > a{
            background: none;
            color: #cccccc;
        }
        ._topbar .navbar-nav .open > a:focus{
            background: none;
            color: #ffffff;
            /*border: ;*/
        }
        ._topbar .dropdown-menu {
            background: #1e1e2f;
        }
        ._topbar .dropdown-menu a {
            color: #cccccc;
        }
        ._topbar .dropdown-menu a:hover{
            background: none;
            color: #ffffff;
        }

        /*地图样式*/
        #testMap {
            height: 100%;
        }

        /*侧边信息框*/
        .fixed-info {
            position: fixed;
            right: 0;
            width: 60px;
            height: 40px;
            background: rgba(0,0,0,.3);
            z-index: 1031;
            border-radius: 8px 0 0 8px;
            text-align: center;
            top: 150px;
        }

        .info-tip {
            width: 60px;
            height: 40px;
        }
        .my-icon {
            display: inline-block;
            font: normal normal normal 1em/1 Nucleo;
            vertical-align: middle;
            speak: none;
            text-transform: none;
            -webkit-font-smoothing: antialiased;
        }

        .icon-menu::before {
            content: "";

        }
        .info-window {
            position: fixed;
            height: 450px;
            right: 80px;
            left: auto!important;
            top: 100px!important;
            width: 360px;
            background-color: #1b1b2d;
            border-radius: .1875rem;
            padding: 0 10px;
            transform-opacity: .5s;
            box-shadow: rgba(0, 0, 0, 0.2) 0 10px 50px 0;
            overflow: scroll;
            font-family: "Roboto", helvetica, arial,sans-serif;
        }

        .fixed-info .info-window .info-window-block {
            margin-top: 20px;
            background: #27293d;
            padding: 0 5px 1px 5px;
            border-radius: 7px;
            transition: all 0.3s;
        }
        .info-window-block-header {
            border-bottom: none;
        }
        .info-window-block-header li a {
            margin-top: 7px;
            padding-top: 13px;
            padding-bottom: 7px;
        }

        .info-window .info-window-block-chart {
            width: inherit;
            height: 300px;
            margin: 0;
        }

        .hamburger .line {
            width: 30px;
            height: 2px;
            background-color: #ecf0f1;
            display: block;
            margin: 8px auto;
            -webkit-transition: all 0.3s ease-in-out;
            -o-transition: all 0.3s ease-in-out;
            transition: all 0.3s ease-in-out;
        }

        .hamburger:hover {
            cursor: pointer;
        }

        #hamburger-1.is-active .line:nth-child(2) {
            opacity: 0;
        }

        #hamburger-1.is-active .line:nth-child(1) {
            -webkit-transform: translateY(10px) rotate(45deg);
            transform: translateY(10px) rotate(45deg);
        }

        #hamburger-1.is-active .line:nth-child(3) {
            -webkit-transform: translateY(-10px) rotate(-45deg);
            -ms-transform: translateY(-10px) rotate(-45deg);
            -o-transform: translateY(-13px) rotate(-45deg);
            transform: translateY(-10px) rotate(-45deg);
        }

    </style>

</head>
<body>
    <!--地图其他思路
        统计模式----地图图表，点击地块查看统计数据，进行距离测量，面积测算（给出坐标）
        信息模式----以专题图形式，针对某一属性，如叶绿素，降雨量绘制地图，并提供相关工具-->
    <nav class="navbar navbar-default navbar-fixed-top _topbar">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">Brand</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="#">首页</a></li>
                <li><a href="#">地图</a></li>
                <li><a href="#">图表</a></li>
                <li class="dropdown">
                    <a role="button" href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">其他<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#">新建用户</a></li>
                        <li><a href="#">添加数据</a></li>
                    </ul>
                </li>
            </ul>

            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a role="button" href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">用户名<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#">用户信息</a></li>
                        <li><a href="#">退出登录</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
    <!--信息窗口-->
    <div class="fixed-info">
        <div class="info-tip">
            <div class="hamburger" id="hamburger-1">
                <span class="line"></span>
                <span class="line"></span>
                <span class="line"></span>
            </div>
        </div>
        <div class="info-window">
            <!--地块信息-->
            <div class="info-window-block">
                <ul class="nav nav-tabs info-window-block-header">
                    <li><i></i><h3 title="地块信息">FieldInfo</h3></li>
                </ul>
                <div id="info-win-chart1">
                    <table class="table table-bordered">
                        <tbody>
                            <tr><td title="地块编号">FieldID</td><td></td></tr>
                            <tr><td title="经纬度">LatLng</td><td></td></tr>
                            <tr><td title="面积(M²)">Area(M²)</td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!--土壤含水量-->
            <div class="info-window-block">
                <ul class="nav nav-tabs info-window-block-header">
                    <li><i></i><h3 title="土壤含水量">SWC</h3></li>
                    <li class="navbar-right"><a href="#" >more</a></li>

                </ul>
                <div class="info-window-block-chart" id="info-win-chart2"></div>
            </div>
            <!--田间持水量-->
            <div>
                <div class="info-window-block">
                    <ul class="nav nav-tabs info-window-block-header">
                        <li><i></i><h3 title="田间持水量">FWH</h3></li>
                        <li class="navbar-right"><a href="#">more</a></li>
                    </ul>
                    <div>
                        <div class="info-window-block-chart" id="info-win-chart3"></div>

                    </div>
                </div>
                <div class="info-window-block">
                    <div class="info-window-block-chart" id="info-win-chart4"></div>
                </div>
            </div>

        </div>
    </div>
    <div id="testMap"></div>

    <script type="text/javascript">
        $(document).ready(function () {
            mapInitial();
            $(".hamburger").click(function(){
                $(this).toggleClass("is-active");
            });
            //chartInitial();
        });

        //初始化地图
        function mapInitial() {
            const normalm = L.tileLayer.chinaProvider('TianDiTu.Normal.Map', {
                maxZoom: 20,
                minZoom: 5
            }), normala = L.tileLayer.chinaProvider('TianDiTu.Normal.Annotion', {
                maxZoom: 20,
                minZoom: 5
            }), imgm = L.tileLayer.chinaProvider('TianDiTu.Satellite.Map', {
                maxZoom: 20,
                minZoom: 5
            }), imga = L.tileLayer.chinaProvider('TianDiTu.Satellite.Annotion', {
                maxZoom: 20,
                minZoom: 5
            });

            const googleNormal = L.tileLayer.chinaProvider("Google.Normal.Map", {
                maxZoom: 20,
                minZoom: 5
            }), googleSate = L.tileLayer.chinaProvider("Google.Satellite.Map", {
                maxZoom: 20,
                minZoom: 5
            });


            const normal = L.layerGroup([normalm, normala]),
                image = L.layerGroup([imgm, imga]),
                googleMap = L.layerGroup([googleSate]);

            const baseLayers = {
                "天地图": image,
                "Google": googleMap
            }, overlayLayers = {
                //"行政地图": normal
            };

            /*天地图坐标定位 40.435071, 109.607786
            * 正常地图定位 40.271171, 109.363286
            * Google地块中心定位 LatLng(40.434209, 109.600875)
            * 天地图地块中心定位 LatLng(40.433294, 109.595275)
            * 1 LatLng(40.435552, 109.595409)
            * 2 LatLng(40.433781, 109.598161)
            * 3 LatLng(40.431398, 109.596847)
            * 4 LatLng(40.431586, 109.593349)
            * 5 LatLng(40.434128, 109.592528)
            * 109.604545, 40.4379
            **/
            const googleCenter = [40.434209, 109.600875];
            const tianDiTuCenter = [40.433294, 109.595275];
            const tianDiTuCenter2 = [40.437924, 109.604577];
            const tianDiTuCenters = [
                [40.433355, 109.595286],
                [40.433322, 109.595361],
                [40.433232, 109.595339],
                [40.433249, 109.5952],
                [40.43333, 109.595178]
            ];
            const markerLonLngs = [
                [40.433349, 109.595275],
                [40.433349, 109.595275],
                [40.433253, 109.595321],
                [40.433247, 109.595229],
                [40.433311, 109.595208]
            ];

            const locationData = [40.435071, 109.607786];
            const map = L.map("testMap", {
                center: locationData,
                zoom: 15,
                layers: [image],
                zoomControl: false
            });
            L.control.layers(baseLayers, overlayLayers).addTo(map);
            L.control.zoom({
                zoomInTitle: '放大',
                zoomOutTitle: '缩小'
            }).addTo(map);
            /*比例尺*/
            L.control.scale().addTo(map);
            /*地图测量*/
            L.control.measure({
                position: "topleft"
            }).addTo(map);
            /*地图交互*/
            map.pm.addControls({
                position: "topleft"
            });
            popTest(map);

            drawField(tianDiTuCenter, map);

            //let markers = addMarker(markerLonLngs, map);
            //fieldOutline(tianDiTuCenter, startAngle, 250, map);
            infoTipListener();
            $(".hamburger").toggleClass("is-active");
        }
        //初始化图表
        function chartInitial() {
            let id = "1-1";
            let latlng = [40.43428, 109.595361];
            fieldInfo(id, latlng);
            swcChart(id);
            fwhChart(id);
        }
        //绘制地块
        function drawField(center, map) {
            let startAngle = [];
            for (let i = 0;i < 15;i++) {
                startAngle[i] = -30 + 24 * i;
            }
            let radius = [390, 320, 225];
            let infoGroup = [];
            for (let i = 0;i < radius.length;i++) {
                let tmpGroup = fieldOutline(center, startAngle[0], radius[i], map);
                infoGroup.push.apply(infoGroup, tmpGroup);
            }
            window.sessionStorage.setItem("fieldInfos", JSON.stringify(infoGroup));
        }
        //绘制一圈地块
        function fieldOutline(latLng, startAngle, radius, paramMap) {
            let tmpAngle = startAngle;
            let fieldInfos = [];//地块信息，放置在session中
            for (let i = 0;i < 5;i++) {//应为5
                drawSector(latLng, radius, [tmpAngle, tmpAngle + 72], paramMap);
                let area = null;
                let area1 = Math.PI * 390 * 390;
                let area2 = Math.PI * 320 * 320;
                let area3 = Math.PI * 225 * 225;
                if (radius === 225) area = area3;
                if (radius === 320) area = area2 - area3;
                if (radius === 390) area = area1 - area2;

                let fieldInfo = {
                    id: calculateID(tmpAngle, radius),
                    area: (area / 5).toFixed(3)
                };
                tmpAngle += 72;//
                fieldInfos.push(fieldInfo);
            }
            return fieldInfos;
        }

        //转换角度和半径为地块编号
        function calculateID(angle, radius) {
            let id = "";
            switch (angle) {
                case -30:
                    id = "1";
                    break;
                case 42:
                    id = "2";
                    break;
                case 114:
                    id = "3";
                    break;
                case 186:
                    id = "4";
                    break;
                case 258:
                    id = "5";
                    break;
            }
            switch (radius) {
                case 225:
                    id += "-1";
                    break;
                case 320:
                    id += "-2";
                    break;
                case 390:
                    id += "-3";
                    break;
            }
            return id;
        }
        //添加标记
        function addMarker(latLng, paramMap) {
            L.marker(latLng, {
                title: "fuck you",
                icon: L.BeautifyIcon.icon({
                    icon: "leaf",
                    iconShape: "marker"
                })
            }).addTo(paramMap);
        }
        //画圆
        //@Param1 地块坐标
        //@Param2 半径
        //@Param3 地图
        function drawMyCircle(latLng, radius, paramMap) {
            return L.circle(latLng, {
                radius: radius,
                color: "#389466",
                weight: 2
            }).addTo(paramMap);
        }
        //画扇形
        //@Param1 地块坐标
        //@Param2 半径
        //@Param3 起始终止角度
        //@Param4 地图
        function drawSector(latLng, radius, angles, paramMap) {

            let sector = L.semiCircle(latLng, {
                radius: radius,
                color: "#389466",
                weight: 2,
                startAngle: angles[0],
                stopAngle: angles[1]
            }).addTo(paramMap);
            sector.on("click", function (event) {
                let fieldId = calculateID(angles[0], radius);
                addMarker(event.latlng, paramMap);
                //调试后取消注释
                fieldInfo(fieldId, event.latlng);
                swcChart(fieldId);
                fwhChart(fieldId);
            });
            return sector;
        }
        //给定圆心，半径和角度，计算圆弧上点画折线来接近圆弧,clockwise
        //但在leaflet地理坐标系中，坐标以经纬度表示，距离用m表示，直接计算加上并不对
        //故在项目中特殊处理，先取定了圆弧上一个点，计算与圆心在坐标系中距离作为半径
        //return 折线数组

        function getArcPoints(center, radius, startAngle, angle, pointNum) {
            let points = [];
            console.log("center is " + center);
            for (let i = 0; i <= pointNum; i++) {
                let current = (startAngle + angle * i / pointNum) * Math.PI / 180;
                let cos = Math.cos(current);
                let sin = Math.sin(current);
                points.push([center[0] + radius * cos, center[1] + radius * sin]);
                console.log("radius is " + radius);
                console.log("cos is " + cos + " sin is " + sin);
            }
            return points;
        }

        //calculate distance of two points
        function getDistance(point1, point2) {
            let x = point1[0] - point2[0];
            let y = point1[1] - point2[1];
            return Math.sqrt(x*x + y*y).toFixed(9);
        }
        //画线段或折线
        //@Param1 点坐标
        //@Param2 地图
        function drawLine(latLngs, paramMap) {
            return L.polyline(latLngs, {
                color: "#389466",
                weight: 2
            }).addTo(paramMap);
        }

        //弹出气泡测试
        //@Param1 地图
        let strs = "";
        let newStrs = "";
        function popTest(paramMap) {
            paramMap.on("click", function (event) {
                strs += event.latlng.toString();
                // let pop = L.popup();
                // pop.setLatLng(event.latlng).setContent(event.latlng.toString()).openOn(paramMap);
            })
        }
        function transform() {
            if (strs !== "") {
                for (let i = 0;i < strs.length;i++) {
                    if (strs.charAt(i) !== '(') continue;
                    let secondPoint = i;
                    while (strs.charAt(secondPoint) !== ')') {
                        secondPoint++;
                    }
                    let latlng = strs.substring(i + 1, secondPoint);
                    newStrs += "[" + latlng + "],\n";
                    i = secondPoint;
                }
                console.log(newStrs);
            }else alert("str is null");
        }
        //info-tip监听
        function infoTipListener() {
            $(".info-tip").on("click", function () {
                //transform();
                let infoWindow = $(".info-window");
                if (infoWindow.css("display") === "none") {
                    $(".hamburger").addClass("is-active");
                    $(infoWindow).fadeIn("normal", "linear");
                }
                else {
                    $(".hamburger").removeClass("is-active");
                    $(infoWindow).fadeOut("normal", "linear");
                }
            });
        }

        //控制info-window
        function showInfoWin() {
            let infoWindow = $(".info-window");
            if (infoWindow.css("display") === "none") {
                $(".hamburger").addClass("is-active");
                $(infoWindow).fadeIn("normal", "linear");
            }
            else {
                $(".hamburger").removeClass("is-active");
                $(infoWindow).fadeOut("normal", "linear");
            }
        }

        //地块信息图表
        function fieldInfo(fieldId, latLng) {
            let infoData = window.sessionStorage.getItem("fieldInfos");
            infoData = JSON.parse(infoData);

            //div->table->tbody
            let tbody = $("#info-win-chart1").children().children()[0];
            let tds = $(tbody).children().children();
            $.each(infoData, function (index, value) {
                if (value.id === fieldId) {
                    $(tds[1]).text(value.id);
                    $(tds[3]).text(latLng.toString().substring(6));
                    $(tds[5]).text(value.area);
                }
            });
        }

        //swc简图
        function swcChart(fieldId) {
            let chartData = screenDataByAttr(getChartData("field/swcByDOY",
            JSON.stringify({DOY: "177"})), "nUM_1", fieldId);
            let xAxisData = extractCol(chartData, "nUM_3");
            let yAxisData = extractCol(chartData, "sWC");
            //console.log("yAxisData is " + yAxisData);
            let swcOption = {
                legend: {},
                tooltip: {},
                xAxis: {
                    type: "category",
                    name: "depth(cm)",
                    nameLocation: "center",
                    nameGap:20,
                    data: xAxisData.sort(function (a, b) {
                        return a - b;
                    })
                },
                yAxis: {
                    name: "%"
                },
                series: [
                    {
                        type: "bar",
                        name: "SWC",
                        data: yAxisData
                    }
                ]
            };
            getAndInitChart("info-win-chart2").setOption(swcOption);
        }

        //FWH简图
        function fwhChart(fieldId) {
            let chartData = screenDataByAttr(getChartData("field/fwh", null, 0), "nUM_1", fieldId);
            let names = extractCol(chartData, "nUM_2");
            let messFWH = extractCol(chartData, "massWaterContent");
            let volumeFWH = extractCol(chartData, "volumeWaterContent");

            let messData = [], volumeData = [];
            for (let i = 0; i < names.length; i++) {
                messData.push({
                    name: names[i],
                    value: messFWH[i]
                });
                volumeData.push({
                    name: names[i],
                    value: volumeFWH[i]
                })
            }

            //图表在容器内部百分比，以宽高中较小的为基准
            let labelCfg = {

            };
            let option1 = {
                title: {
                    subtext: "MessWaterContent",
                    left: "50%",
                    top: "80%",
                    textAlign: "center"
                },
                legend: {},
                tooltip:{},
                series: {
                    type: "pie",
                    center: ["50%", "45%"],
                    radius: "50%",
                    data: messData,
                    label: labelCfg
                }
            }, option2 = {
                title: {
                    subtext: "VolumeWaterContent",
                    left: "50%",
                    top: "85%",
                    textAlign: "center"
                },
                legend: {
                    top: "5%"
                },
                tooltip:{},
                series: {
                    type: "pie",
                    center: ["50%", "50%"],
                    radius: "50%",
                    data: volumeData,
                    label: labelCfg
                }
            };

            getAndInitChart("info-win-chart3").setOption(option1);
            getAndInitChart("info-win-chart4").setOption(option2);
        }
        /**
         * 作者: SilentSherlock
         * 描述：向后台发送请求获取数据,默认带请求数据
         */
        function getChartData(requestUrl, jsonStr, flag = 1) {
            let chartData = null;

            const tmpData = window.sessionStorage.getItem(requestUrl+jsonStr);
            if (tmpData != null) {
                chartData = JSON.parse(tmpData);
                return chartData;
            }
            if (requestUrl != null) {
                //图表数据获取成功回调函数
                function callback(data) {
                    if (data === "0")
                        alert("获取图表数据失败");
                    else {
                        chartData = data;
                        const dataStr = JSON.stringify(chartData);
                        //console.log(dataStr);
                        window.sessionStorage.setItem(requestUrl+jsonStr, dataStr);
                    }
                }

                //根据请求类别发送请求
                if (flag === 1) {
                    $.ajax({
                        url: requestUrl,
                        type: "post",
                        data: jsonStr,
                        async: false,
                        contentType: "application/json;charset=UTF-8",
                        dataType: "json",   //dataType为json时得到的数据格式为json对象，但是后端发送数据时需发送json字符串
                        success: callback,
                        error: function (error) {
                            alert("----ajax请求获取图表数据失败！错误信息如下：----\n" + error.responseText);
                        }
                    });
                } else if (flag === 0) {
                    $.ajax({
                        url: requestUrl,
                        type: "get",
                        async: false,
                        dataType: "json",
                        success: callback,
                        error: function (error) {
                            alert("----ajax请求获取图表数据失败！错误信息如下：----\n" + error.responseText);
                        }
                    });
                } else
                    alert("图表数据请求类型出错");
            } else
                alert("图表数据请求url不能为空");

            return chartData;
        }

        /**
         * 作者: SilentSherlock
         * 描述：初始化图表节点
         */
        function getAndInitChart(chartDomId, theme = "purple") {
            let chartDom = document.getElementById(chartDomId);
            return echarts.init(chartDom, theme)
        }

        /**
         * 作者: SilentSherlock
         * 描述：从JSON对象数组中根据某个属性值筛选部分对象
         */
        function screenDataByAttr(chartData, attrName, attrValue) {
            let result = [];
            let i = 0;
            $.each(chartData, function (key, value) {
                if (value[attrName] === attrValue) {
                    result.push(value);
                    i++
                }
            });
            return result;
        }

        /**
         * 作者: SilentSherlock
         * 描述：提取JSON对象数组中的某一列数据
         */
        function extractCol(chartData, colName) {
            let colData = [];
            $.each(chartData, function (key, value) {
                if (value.hasOwnProperty(colName))
                    colData.push(value[colName]);
            });
            return colData;
        }
    </script>
</body>
</html>